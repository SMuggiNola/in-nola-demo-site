<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="../assets/in_logo.png">
  <meta charset="UTF-8">
  <title>Task Dashboard | Irish Network NOLA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/global.css">
  <style>
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .dashboard-header h1 {
      margin: 0;
    }

    .logout-btn {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }

    .progress-summary {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .progress-card {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding: 1rem 1.5rem;
      text-align: center;
      min-width: 120px;
    }

    .progress-card .number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--gold);
    }

    .progress-card .label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .phase-section {
      margin-bottom: 1rem;
    }

    .phase-header {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding: 1rem 1.25rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all var(--transition);
    }

    .phase-header:hover {
      background: var(--glass-hover);
      border-color: rgba(212, 167, 38, 0.3);
    }

    .phase-header.active {
      border-radius: var(--radius) var(--radius) 0 0;
      border-bottom-color: transparent;
    }

    .phase-title {
      font-family: 'Cinzel Decorative', serif;
      font-size: 1.1rem;
      color: var(--gold);
      margin: 0;
    }

    .phase-status {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .phase-count {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .phase-arrow {
      transition: transform 0.3s ease;
      color: var(--gold);
    }

    .phase-header.active .phase-arrow {
      transform: rotate(180deg);
    }

    .phase-content {
      background: rgba(13, 40, 24, 0.4);
      border: 1px solid var(--glass-border);
      border-top: none;
      border-radius: 0 0 var(--radius) var(--radius);
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }

    .phase-content.open {
      padding: 1rem 1.25rem;
      max-height: 2000px;
    }

    .phase-description {
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-style: italic;
      margin: 0 0 1rem 0;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .task-item {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.6rem 0.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      transition: background 0.2s ease;
    }

    .task-item:hover {
      background: rgba(212, 167, 38, 0.1);
    }

    .task-item:last-child {
      border-bottom: none;
    }

    .task-checkbox {
      color: var(--gold);
      font-size: 1.1rem;
      flex-shrink: 0;
      margin-top: 0.1rem;
      cursor: pointer;
      user-select: none;
    }

    .task-checkbox:hover {
      transform: scale(1.2);
    }

    .task-checkbox.done {
      color: #86efac;
    }

    .task-text {
      color: var(--text-secondary);
      font-size: 0.95rem;
      line-height: 1.4;
      text-decoration: none;
    }

    .task-text.done {
      text-decoration: line-through;
      opacity: 0.6;
    }

    .task-text strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    a.task-text:hover {
      color: var(--text-primary);
    }

    .owner-tag {
      display: inline-block;
      font-size: 0.65rem;
      padding: 0.15rem 0.5rem;
      border-radius: 10px;
      margin-left: 0.5rem;
      vertical-align: middle;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .owner-tag.board {
      background: rgba(212, 167, 38, 0.25);
      color: #f0c040;
      border: 1px solid rgba(212, 167, 38, 0.4);
    }

    .owner-tag.treasurer {
      background: rgba(168, 85, 247, 0.2);
      color: #c084fc;
      border: 1px solid rgba(168, 85, 247, 0.4);
    }

    .owner-tag.tech {
      background: rgba(100, 116, 139, 0.2);
      color: #94a3b8;
      border: 1px solid rgba(100, 116, 139, 0.3);
    }

    /* Dim tech tasks so board tasks stand out */
    .task-item.owner-tech {
      opacity: 0.6;
    }

    .task-item.owner-tech:hover {
      opacity: 1;
    }

    /* Highlight board/treasurer tasks */
    .task-item.owner-board,
    .task-item.owner-treasurer {
      background: rgba(212, 167, 38, 0.05);
    }

    .task-item.owner-treasurer {
      background: rgba(168, 85, 247, 0.05);
    }

    .legend-box {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .subsection-title {
      color: var(--gold);
      font-size: 0.9rem;
      font-weight: 600;
      margin: 1rem 0 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .subsection-title:first-child {
      margin-top: 0;
      padding-top: 0;
      border-top: none;
    }

    .back-link {
      text-align: center;
      margin-top: 2rem;
    }

    .back-link a {
      color: var(--text-secondary);
      text-decoration: none;
    }

    .back-link a:hover {
      color: var(--gold);
    }
  </style>
</head>

<body>

  <div id="main-header-placeholder"></div>

  <div id="main-content">
    <main class="page-content" style="max-width: 800px;">

      <div class="dashboard-header">
        <h1>Task Dashboard</h1>
        <button id="logoutBtn" class="btn btn-gold logout-btn">Sign Out</button>
      </div>

      <div style="background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius); padding: 1.25rem; margin-bottom: 2rem;">
        <p style="text-align: center; margin-bottom: 1rem;">
          Project tasks and progress for the IN-NOLA website and membership portal.
        </p>
        <div style="background: rgba(212, 167, 38, 0.1); border-radius: 8px; padding: 1rem; font-size: 0.9rem;">
          <strong style="color: var(--gold);">How to Help:</strong>
          <ol style="margin: 0.5rem 0 0 1.25rem; padding: 0; color: var(--text-secondary);">
            <li>Look for <span class="owner-tag board">Board</span> or <span class="owner-tag treasurer">Treasurer</span> tags - those need your input</li>
            <li>Click any task to open an email with the task name pre-filled</li>
            <li>Add any info, credentials, or details needed</li>
            <li><span class="owner-tag tech">Tech</span> tasks are handled by Sean - no action needed from you</li>
          </ol>
          <div class="legend-box">
            <div class="legend-item"><span class="owner-tag board">Board</span> Needs board member input</div>
            <div class="legend-item"><span class="owner-tag treasurer">Treasurer</span> Needs treasurer action</div>
            <div class="legend-item"><span class="owner-tag tech">Tech</span> Technical work (Sean)</div>
          </div>
        </div>
      </div>

      <div class="progress-summary">
        <div class="progress-card">
          <div class="number" id="totalTasks">0</div>
          <div class="label">Total Tasks</div>
        </div>
        <div class="progress-card">
          <div class="number" id="completedTasks">0</div>
          <div class="label">Completed</div>
        </div>
        <div class="progress-card">
          <div class="number" id="remainingTasks">0</div>
          <div class="label">Remaining</div>
        </div>
        <div class="progress-card">
          <div class="number" id="boardTasks">0</div>
          <div class="label">Board Tasks</div>
        </div>
      </div>

      <div id="phasesContainer"></div>

      <div class="back-link">
        <a href="home.html">Back to Admin Portal</a>
      </div>

    </main>

    <div id="main-footer-placeholder"></div>
  </div>

  <script src="/js/main.js"></script>
  <script src="/js/admin-auth.js"></script>
  <script>
    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', function() {
      adminLogout();
    });

    // Task data loaded from API
    let phases = [];

    // Email config
    const BOARD_EMAIL = 'sean.muggivan@gmail.com';

    // Helper to strip HTML and create mailto link
    function createMailtoLink(taskText, phaseTitle) {
      const plainText = taskText.replace(/<[^>]*>/g, '').trim();
      const subject = encodeURIComponent(`[IN-NOLA Task] ${phaseTitle}: ${plainText}`);
      const body = encodeURIComponent(`Hi Sean,\n\nRegarding the task: "${plainText}"\n\nHere's the information you need:\n\n\n\n---\nSent from IN-NOLA Board Portal`);
      return `mailto:${BOARD_EMAIL}?subject=${subject}&body=${body}`;
    }

    // Helper to get owner tag HTML
    function getOwnerTag(owner) {
      const labels = {
        board: 'Board',
        treasurer: 'Treasurer',
        tech: 'Tech'
      };
      return owner ? `<span class="owner-tag ${owner}">${labels[owner] || owner}</span>` : '';
    }

    // Toggle task done/undone via API
    async function toggleTask(taskId, currentDone) {
      const newDone = !currentDone;

      // Optimistic update â€” flip checkbox immediately
      const checkbox = document.querySelector(`[data-task-id="${taskId}"] .task-checkbox`);
      const textEl = document.querySelector(`[data-task-id="${taskId}"] .task-text`);
      if (checkbox) {
        checkbox.classList.toggle('done');
        checkbox.innerHTML = newDone ? '&#10003;' : '&#9675;';
      }
      if (textEl) {
        textEl.classList.toggle('done');
      }

      // Update local data
      for (const phase of phases) {
        for (const task of phase.tasks) {
          if (task.id === taskId) { task.done = newDone; break; }
          if (task.subtasks) {
            for (const sub of task.subtasks) {
              if (sub.id === taskId) { sub.done = newDone; break; }
            }
          }
        }
      }

      // Update progress cards from local data
      updateProgressCards();

      // Persist to API
      try {
        const res = await fetch('/api/tasks', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            adminPassword: getAdminPassword(),
            taskId: taskId,
            field: 'done',
            value: newDone
          })
        });
        if (!res.ok) throw new Error('API error');
      } catch (err) {
        // Revert on failure
        if (checkbox) {
          checkbox.classList.toggle('done');
          checkbox.innerHTML = currentDone ? '&#10003;' : '&#9675;';
        }
        if (textEl) {
          textEl.classList.toggle('done');
        }
        // Revert local data
        for (const phase of phases) {
          for (const task of phase.tasks) {
            if (task.id === taskId) { task.done = currentDone; break; }
            if (task.subtasks) {
              for (const sub of task.subtasks) {
                if (sub.id === taskId) { sub.done = currentDone; break; }
              }
            }
          }
        }
        updateProgressCards();
        console.error('Failed to toggle task:', err);
      }
    }

    // Update progress summary cards from current local data
    function updateProgressCards() {
      let totalTasks = 0, completedTasks = 0, boardTasks = 0;
      phases.forEach(phase => {
        phase.tasks.forEach(task => {
          totalTasks++;
          if (task.done) completedTasks++;
          if (!task.done && (task.owner === 'board' || task.owner === 'treasurer')) boardTasks++;
          if (task.subtasks) {
            task.subtasks.forEach(sub => {
              totalTasks++;
              if (sub.done) completedTasks++;
              if (!sub.done && (sub.owner === 'board' || sub.owner === 'treasurer')) boardTasks++;
            });
          }
        });
      });
      document.getElementById('totalTasks').textContent = totalTasks;
      document.getElementById('completedTasks').textContent = completedTasks;
      document.getElementById('remainingTasks').textContent = totalTasks - completedTasks;
      document.getElementById('boardTasks').textContent = boardTasks;

      // Also update phase counts in headers
      phases.forEach((phase, index) => {
        let phaseDone = 0, phaseTotal = 0;
        phase.tasks.forEach(task => {
          phaseTotal++;
          if (task.done) phaseDone++;
          if (task.subtasks) {
            task.subtasks.forEach(sub => { phaseTotal++; if (sub.done) phaseDone++; });
          }
        });
        const countEl = document.querySelector(`.phase-header[data-index="${index}"] .phase-count`);
        if (countEl) countEl.textContent = `${phaseDone}/${phaseTotal}`;
      });
    }

    // Render phases into DOM
    function renderPhases() {
      const container = document.getElementById('phasesContainer');
      container.innerHTML = '';

      phases.forEach((phase, index) => {
        const phaseEl = document.createElement('div');
        phaseEl.className = 'phase-section';

        let phaseDone = 0;
        let phaseTotal = 0;

        // Count tasks
        phase.tasks.forEach(task => {
          phaseTotal++;
          if (task.done) phaseDone++;
          if (task.subtasks) {
            task.subtasks.forEach(sub => {
              phaseTotal++;
              if (sub.done) phaseDone++;
            });
          }
        });

        // Build task HTML
        let tasksHtml = '';
        phase.tasks.forEach(task => {
          const checkIcon = task.done ? '&#10003;' : '&#9675;';
          const checkClass = task.done ? 'done' : '';
          const ownerTag = getOwnerTag(task.owner);
          const ownerClass = task.owner ? `owner-${task.owner}` : '';
          const mailtoLink = createMailtoLink(task.text, phase.title);

          tasksHtml += `
            <div class="task-item ${ownerClass}" data-task-id="${task.id}">
              <span class="task-checkbox ${checkClass}" onclick="event.stopPropagation(); toggleTask('${task.id}', ${task.done})" title="Click to toggle done">${checkIcon}</span>
              <a href="${mailtoLink}" class="task-text ${checkClass}" title="Click to email info about this task">${task.text}${ownerTag}</a>
            </div>
          `;

          if (task.subtasks) {
            task.subtasks.forEach(sub => {
              const subCheckIcon = sub.done ? '&#10003;' : '&#9675;';
              const subCheckClass = sub.done ? 'done' : '';
              const subOwnerTag = getOwnerTag(sub.owner);
              const subOwnerClass = sub.owner ? `owner-${sub.owner}` : '';
              const subMailtoLink = createMailtoLink(sub.text, phase.title);
              tasksHtml += `
                <div class="task-item ${subOwnerClass}" data-task-id="${sub.id}" style="padding-left: 1.5rem;">
                  <span class="task-checkbox ${subCheckClass}" onclick="event.stopPropagation(); toggleTask('${sub.id}', ${sub.done})" title="Click to toggle done">${subCheckIcon}</span>
                  <a href="${subMailtoLink}" class="task-text ${subCheckClass}" title="Click to email info about this task">${sub.text}${subOwnerTag}</a>
                </div>
              `;
            });
          }
        });

        const descriptionHtml = phase.description
          ? `<p class="phase-description">${phase.description}</p>`
          : '';

        phaseEl.innerHTML = `
          <div class="phase-header" data-index="${index}">
            <h3 class="phase-title">${phase.title}</h3>
            <div class="phase-status">
              <span class="phase-count">${phaseDone}/${phaseTotal}</span>
              <span class="phase-arrow">&#9660;</span>
            </div>
          </div>
          <div class="phase-content" data-index="${index}">
            ${descriptionHtml}
            ${tasksHtml}
          </div>
        `;

        container.appendChild(phaseEl);
      });

      // Update summary cards
      updateProgressCards();
    }

    // Toggle phase dropdowns
    document.addEventListener('click', function(e) {
      const header = e.target.closest('.phase-header');
      if (header) {
        const index = header.dataset.index;
        const content = document.querySelector(`.phase-content[data-index="${index}"]`);

        header.classList.toggle('active');
        content.classList.toggle('open');
      }
    });

    // Load tasks from API
    async function loadTasks() {
      const container = document.getElementById('phasesContainer');
      container.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 2rem;">Loading tasks...</p>';

      try {
        const res = await fetch('/api/tasks?adminPassword=' + encodeURIComponent(getAdminPassword()));
        if (!res.ok) throw new Error('API returned ' + res.status);
        const data = await res.json();
        phases = data.phases || [];
        renderPhases();
      } catch (err) {
        console.error('Failed to load tasks:', err);
        container.innerHTML = `
          <div style="text-align:center; padding: 2rem; color: var(--text-secondary);">
            <p>Could not load tasks from server.</p>
            <p style="font-size: 0.85rem; margin-top: 0.5rem;">Check your connection or try refreshing the page.</p>
          </div>
        `;
      }
    }

    // Initialize
    loadTasks();
  </script>

</body>
</html>
