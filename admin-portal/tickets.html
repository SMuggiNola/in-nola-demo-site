<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="../assets/in_logo.png">
  <meta charset="UTF-8">
  <title>Tech Requests | Irish Network NOLA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/global.css">
  <style>
    .tickets-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .tickets-header h1 {
      margin: 0;
    }

    .logout-btn {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }

    /* Summary cards */
    .progress-summary {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .progress-card {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding: 1rem 1.5rem;
      text-align: center;
      min-width: 120px;
    }

    .progress-card .number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--gold);
    }

    .progress-card .label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    /* Submit form section */
    .phase-section {
      margin-bottom: 1rem;
    }

    .phase-header {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding: 1rem 1.25rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all var(--transition);
    }

    .phase-header:hover {
      background: var(--glass-hover);
      border-color: rgba(212, 167, 38, 0.3);
    }

    .phase-header.active {
      border-radius: var(--radius) var(--radius) 0 0;
      border-bottom-color: transparent;
    }

    .phase-title {
      font-family: 'Cinzel Decorative', serif;
      font-size: 1.1rem;
      color: var(--gold);
      margin: 0;
    }

    .phase-arrow {
      transition: transform 0.3s ease;
      color: var(--gold);
    }

    .phase-header.active .phase-arrow {
      transform: rotate(180deg);
    }

    .phase-content {
      background: rgba(13, 40, 24, 0.4);
      border: 1px solid var(--glass-border);
      border-top: none;
      border-radius: 0 0 var(--radius) var(--radius);
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }

    .phase-content.open {
      padding: 1.25rem;
      max-height: 2000px;
    }

    /* Form styles */
    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      color: var(--gold);
      font-weight: 600;
      margin-bottom: 0.4rem;
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.6rem 0.8rem;
      border: 1px solid var(--glass-border);
      border-radius: 6px;
      background: rgba(0, 0, 0, 0.2);
      color: var(--text-primary);
      font-size: 0.95rem;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--gold);
    }

    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-group select {
      cursor: pointer;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    @media (max-width: 500px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    .submit-btn {
      width: 100%;
      padding: 0.75rem;
      background: var(--gold);
      color: var(--green-dark);
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .submit-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(212, 167, 38, 0.4);
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .status-message {
      text-align: center;
      padding: 0.75rem;
      border-radius: 8px;
      margin-top: 0.75rem;
      display: none;
      font-size: 0.9rem;
    }

    .status-message.success {
      display: block;
      background: rgba(34, 197, 94, 0.2);
      color: #86efac;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .status-message.error {
      display: block;
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    /* Section headers */
    .section-header {
      font-family: 'Cinzel Decorative', serif;
      font-size: 1.2rem;
      color: var(--gold);
      margin: 2rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(212, 167, 38, 0.3);
    }

    /* Ticket cards */
    .ticket-card {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      margin-bottom: 0.75rem;
      overflow: hidden;
      transition: all var(--transition);
    }

    .ticket-card:hover {
      border-color: rgba(212, 167, 38, 0.3);
    }

    .ticket-header {
      padding: 1rem 1.25rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
    }

    .ticket-header:hover {
      background: var(--glass-hover);
    }

    .ticket-header-left {
      flex: 1;
      min-width: 0;
    }

    .ticket-title {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }

    .ticket-meta {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .ticket-header-right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    .priority-badge {
      display: inline-block;
      font-size: 0.65rem;
      padding: 0.15rem 0.5rem;
      border-radius: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .priority-badge.high {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.4);
    }

    .priority-badge.medium {
      background: rgba(212, 167, 38, 0.2);
      color: #f0c040;
      border: 1px solid rgba(212, 167, 38, 0.4);
    }

    .priority-badge.low {
      background: rgba(100, 116, 139, 0.2);
      color: #94a3b8;
      border: 1px solid rgba(100, 116, 139, 0.3);
    }

    .ticket-toggle {
      color: var(--gold);
      font-size: 1.1rem;
    }

    .quick-action-btn {
      font-size: 0.7rem;
      padding: 0.2rem 0.6rem;
      border-radius: 10px;
      border: 1px solid rgba(212, 167, 38, 0.4);
      background: rgba(212, 167, 38, 0.15);
      color: #f0c040;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
      transition: all 0.2s ease;
    }

    .quick-action-btn:hover {
      background: rgba(212, 167, 38, 0.3);
      transform: scale(1.05);
    }

    .status-badge {
      display: inline-block;
      font-size: 0.6rem;
      padding: 0.15rem 0.5rem;
      border-radius: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .status-badge.in-progress {
      background: rgba(59, 130, 246, 0.2);
      color: #93c5fd;
      border: 1px solid rgba(59, 130, 246, 0.4);
    }

    .status-badge.completed {
      background: rgba(34, 197, 94, 0.2);
      color: #86efac;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    /* Ticket body (expanded) */
    .ticket-body {
      display: none;
      padding: 0 1.25rem 1.25rem;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .ticket-card.open .ticket-body {
      display: block;
    }

    .ticket-description {
      color: var(--text-secondary);
      font-size: 0.95rem;
      line-height: 1.5;
      margin: 1rem 0;
      white-space: pre-wrap;
    }

    /* Comments */
    .comments-section {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .comments-title {
      color: var(--gold);
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
    }

    .comment-item {
      background: rgba(0, 0, 0, 0.15);
      border-radius: 6px;
      padding: 0.6rem 0.8rem;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .comment-item .comment-author {
      color: var(--gold);
      font-weight: 600;
      font-size: 0.8rem;
    }

    .comment-item .comment-date {
      color: var(--text-secondary);
      font-size: 0.75rem;
      margin-left: 0.5rem;
    }

    .comment-item .comment-text {
      color: var(--text-secondary);
      margin-top: 0.25rem;
      line-height: 1.4;
    }

    .add-comment-form {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .add-comment-form input {
      flex: 1;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--glass-border);
      border-radius: 6px;
      background: rgba(0, 0, 0, 0.2);
      color: var(--text-primary);
      font-size: 0.85rem;
      font-family: inherit;
    }

    .add-comment-form input:focus {
      outline: none;
      border-color: var(--gold);
    }

    .add-comment-form button {
      padding: 0.5rem 0.75rem;
      background: var(--gold);
      color: var(--green-dark);
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.8rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .add-comment-form button:hover {
      box-shadow: 0 2px 8px rgba(212, 167, 38, 0.4);
    }

    /* Ticket actions */
    .ticket-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .ticket-actions button {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: var(--text-secondary);
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .ticket-actions button:hover {
      border-color: var(--gold);
      color: var(--gold);
    }

    .ticket-actions .status-btn.active {
      background: rgba(212, 167, 38, 0.2);
      border-color: var(--gold);
      color: var(--gold);
    }

    .ticket-actions .delete-btn:hover {
      border-color: #f87171;
      color: #f87171;
    }

    /* No tickets message */
    .no-tickets {
      text-align: center;
      color: var(--text-secondary);
      padding: 1.5rem;
      font-style: italic;
      opacity: 0.8;
    }

    .loading-message {
      text-align: center;
      color: var(--text-secondary);
      padding: 2rem;
      font-style: italic;
    }

    /* Modal styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #0a2818;
      border: 1px solid rgba(212, 167, 38, 0.4);
      border-radius: var(--radius);
      max-width: 400px;
      width: 100%;
      padding: 1.5rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    }

    .modal h2 {
      color: var(--gold);
      margin: 0 0 1rem;
      font-size: 1.3rem;
    }

    .delete-warning {
      color: #fca5a5;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    .modal-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    .modal-actions button {
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-actions .cancel-btn {
      background: transparent;
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
    }

    .modal-actions .cancel-btn:hover {
      border-color: var(--text-primary);
      color: var(--text-primary);
    }

    .modal-actions .delete-confirm-btn {
      background: #dc2626;
      border: none;
      color: white;
    }

    .modal-actions .delete-confirm-btn:hover {
      background: #b91c1c;
    }

    .back-link {
      text-align: center;
      margin-top: 2rem;
    }

    .back-link a {
      color: var(--text-secondary);
      text-decoration: none;
    }

    .back-link a:hover {
      color: var(--gold);
    }

    /* Completed section - muted */
    .completed-section .ticket-card {
      opacity: 0.7;
    }

    .completed-section .ticket-card:hover {
      opacity: 1;
    }
  </style>
</head>

<body>

  <div id="main-header-placeholder"></div>

  <div id="main-content">
    <main class="page-content" style="max-width: 800px;">

      <div class="tickets-header">
        <h1>Tech Requests</h1>
        <button id="logoutBtn" class="btn btn-gold logout-btn">Sign Out</button>
      </div>

      <!-- Summary Cards -->
      <div class="progress-summary">
        <div class="progress-card">
          <div class="number" id="openCount">0</div>
          <div class="label">Open</div>
        </div>
        <div class="progress-card">
          <div class="number" id="progressCount">0</div>
          <div class="label">In Progress</div>
        </div>
        <div class="progress-card">
          <div class="number" id="completedCount">0</div>
          <div class="label">Completed</div>
        </div>
      </div>

      <!-- Submit New Ticket -->
      <div class="phase-section">
        <div class="phase-header" id="submitToggle">
          <h3 class="phase-title">Submit New Request</h3>
          <span class="phase-arrow">&#9660;</span>
        </div>
        <div class="phase-content" id="submitForm">
          <form id="ticketForm">
            <div class="form-group">
              <label for="ticketTitle">Title *</label>
              <input type="text" id="ticketTitle" required placeholder="Brief summary of the request">
            </div>

            <div class="form-group">
              <label for="ticketDescription">Description *</label>
              <textarea id="ticketDescription" required placeholder="Describe what you need - include any details, links, or examples that would help"></textarea>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="ticketPriority">Priority</label>
                <select id="ticketPriority">
                  <option value="low">Low</option>
                  <option value="medium" selected>Medium</option>
                  <option value="high">High</option>
                </select>
              </div>
              <div class="form-group">
                <label for="ticketSubmitter">Your Name *</label>
                <select id="ticketSubmitter" required>
                  <option value="" disabled selected>Select your name</option>
                  <option value="Shannon">Shannon</option>
                  <option value="Erin">Erin</option>
                  <option value="Joni">Joni</option>
                  <option value="Andrew">Andrew</option>
                  <option value="Colm">Colm</option>
                  <option value="Sean">Sean</option>
                </select>
              </div>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">Submit Request</button>
            <div class="status-message" id="formStatus"></div>
          </form>
        </div>
      </div>

      <!-- Tickets List -->
      <div id="ticketsContainer">
        <p class="loading-message">Loading tickets...</p>
      </div>

      <div class="back-link">
        <a href="home.html">Back to Admin Portal</a>
      </div>

    </main>

    <div id="main-footer-placeholder"></div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal">
      <h2>Delete Ticket</h2>
      <p class="delete-warning">Are you sure you want to delete "<span id="deleteTicketTitle"></span>"? This cannot be undone.</p>
      <input type="hidden" id="deleteTicketId">
      <div class="modal-actions">
        <button type="button" class="cancel-btn" onclick="closeDeleteModal()">Cancel</button>
        <button type="button" class="delete-confirm-btn" onclick="confirmDelete()">Delete Ticket</button>
      </div>
    </div>
  </div>

  <!-- Close with Comment Modal -->
  <div class="modal-overlay" id="closeModal">
    <div class="modal">
      <h2>Close Ticket</h2>
      <p style="color: var(--text-secondary); margin-bottom: 1rem;">Closing "<span id="closeTicketTitle"></span>"</p>
      <input type="hidden" id="closeTicketId">
      <div class="form-group" style="margin-bottom: 1rem;">
        <label for="closeComment">Closing comment *</label>
        <textarea id="closeComment" required placeholder="What was done to resolve this?" style="width:100%; min-height:80px; padding:0.6rem 0.8rem; border:1px solid var(--glass-border); border-radius:6px; background:rgba(0,0,0,0.2); color:var(--text-primary); font-size:0.9rem; font-family:inherit; resize:vertical;"></textarea>
      </div>
      <div class="modal-actions">
        <button type="button" class="cancel-btn" onclick="closeCloseModal()">Cancel</button>
        <button type="button" class="submit-btn" style="width:auto; padding:0.6rem 1.2rem; font-size:0.9rem;" onclick="confirmClose()">Close Ticket</button>
      </div>
    </div>
  </div>

  <script src="/js/main.js"></script>
  <script src="/js/admin-auth.js"></script>
  <script>
    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', function() {
      adminLogout();
    });

    // Store tickets data
    let allTickets = [];
    const isAdmin = getUserRole() === 'admin';

    // HTML escaping for safe output
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Format date
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
    }

    function formatDateTime(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
      });
    }

    // Toggle submit form
    document.getElementById('submitToggle').addEventListener('click', function() {
      this.classList.toggle('active');
      document.getElementById('submitForm').classList.toggle('open');
    });

    // Load tickets from API
    async function loadTickets() {
      const container = document.getElementById('ticketsContainer');

      try {
        const password = getAdminPassword();
        const response = await fetch('/api/tickets?adminPassword=' + encodeURIComponent(password));
        const contentType = response.headers.get('content-type');

        if (!response.ok || !contentType || !contentType.includes('application/json')) {
          container.innerHTML = '<p class="no-tickets">API not available. Deploy to Cloudflare to use tickets.</p>';
          return;
        }

        const data = await response.json();

        if (data.error === 'KV not configured') {
          container.innerHTML = '<p class="no-tickets">Tickets KV not configured yet. Create TICKETS_KV namespace in Cloudflare.</p>';
          return;
        }

        if (data.error) {
          container.innerHTML = '<p class="no-tickets">Error: ' + escapeHtml(data.error) + '</p>';
          return;
        }

        allTickets = data.tickets || [];
        renderTickets();

      } catch (error) {
        console.error('Failed to load tickets:', error);
        container.innerHTML = '<p class="no-tickets">Failed to load tickets. Make sure you\'re on the deployed site.</p>';
      }
    }

    // Render tickets grouped by status
    function renderTickets() {
      const container = document.getElementById('ticketsContainer');

      const open = allTickets.filter(t => t.status === 'open');
      const inProgress = allTickets.filter(t => t.status === 'in-progress');
      const completed = allTickets.filter(t => t.status === 'completed');

      // Update summary
      document.getElementById('openCount').textContent = open.length;
      document.getElementById('progressCount').textContent = inProgress.length;
      document.getElementById('completedCount').textContent = completed.length;

      let html = '';

      // Open tickets
      if (open.length > 0) {
        html += '<h2 class="section-header">Open</h2>';
        html += open.map(t => createTicketCard(t)).join('');
      }

      // In Progress tickets
      if (inProgress.length > 0) {
        html += '<h2 class="section-header">In Progress</h2>';
        html += inProgress.map(t => createTicketCard(t)).join('');
      }

      // Completed tickets
      if (completed.length > 0) {
        html += '<div class="completed-section">';
        html += '<h2 class="section-header">Completed</h2>';
        html += completed.map(t => createTicketCard(t)).join('');
        html += '</div>';
      }

      if (allTickets.length === 0) {
        html = '<p class="no-tickets">No tickets yet. Submit a request above to get started.</p>';
      }

      container.innerHTML = html;

      // Attach accordion handlers
      container.querySelectorAll('.ticket-header').forEach(header => {
        header.addEventListener('click', function(e) {
          if (e.target.closest('.ticket-actions') || e.target.closest('.add-comment-form')) return;
          const card = this.closest('.ticket-card');
          card.classList.toggle('open');
          const toggle = card.querySelector('.ticket-toggle');
          toggle.textContent = card.classList.contains('open') ? '\u2212' : '+';
        });
      });
    }

    // Create ticket card HTML
    function createTicketCard(ticket) {
      const submitter = (isAdmin && ticket.submittedBy) ? ' by ' + escapeHtml(ticket.submittedBy) : '';
      const dateStr = formatDate(ticket.createdAt);

      // Comments HTML — visible to everyone
      let commentsHtml = '';
      if (ticket.comments && ticket.comments.length > 0) {
        commentsHtml = ticket.comments.map(c => `
          <div class="comment-item">
            <span class="comment-author">${escapeHtml(c.author)}</span>
            <span class="comment-date">${formatDateTime(c.createdAt)}</span>
            <div class="comment-text">${escapeHtml(c.text)}</div>
          </div>
        `).join('');
      }

      // Comment input — admin only
      const commentFormHtml = isAdmin ? `
        <div class="add-comment-form">
          <input type="text" placeholder="Add a comment..." id="comment-${ticket.id}" onkeydown="if(event.key==='Enter'){event.preventDefault();addComment('${ticket.id}');}">
          <button type="button" onclick="addComment('${ticket.id}')">Post</button>
        </div>
      ` : '';

      // Status action buttons and delete — admin only
      let actionsHtml = '';
      if (isAdmin) {
        let statusButtons = '';
        if (ticket.status === 'open') {
          statusButtons = `<button type="button" class="status-btn" onclick="updateStatus('${ticket.id}', 'in-progress')">Mark In Progress</button>
            <button type="button" class="status-btn" onclick="openCloseModal('${ticket.id}', '${escapeHtml(ticket.title).replace(/'/g, "\\'")}')">Close with Comment</button>`;
        } else if (ticket.status === 'in-progress') {
          statusButtons = `<button type="button" class="status-btn" onclick="updateStatus('${ticket.id}', 'open')">Reopen</button>
            <button type="button" class="status-btn" onclick="openCloseModal('${ticket.id}', '${escapeHtml(ticket.title).replace(/'/g, "\\'")}')">Close with Comment</button>`;
        } else {
          statusButtons = `<button type="button" class="status-btn" onclick="updateStatus('${ticket.id}', 'open')">Reopen</button>`;
        }

        actionsHtml = `
          <div class="ticket-actions">
            ${statusButtons}
            <button type="button" class="delete-btn" onclick="openDeleteModal('${ticket.id}', '${escapeHtml(ticket.title).replace(/'/g, "\\'")}')">Delete</button>
          </div>
        `;
      }

      // Quick-action button in header — admin only
      let quickActionHtml = '';
      if (isAdmin && ticket.status === 'open') {
        quickActionHtml = `<button type="button" class="quick-action-btn" onclick="event.stopPropagation(); updateStatus('${ticket.id}', 'in-progress')">Working On It</button>`;
      } else if (ticket.status === 'in-progress') {
        quickActionHtml = `<span class="status-badge in-progress">In Progress</span>`;
      } else if (ticket.status === 'completed') {
        quickActionHtml = `<span class="status-badge completed">Closed</span>`;
      }

      return `
        <div class="ticket-card" data-ticket-id="${ticket.id}">
          <div class="ticket-header">
            <div class="ticket-header-left">
              <div class="ticket-title">${escapeHtml(ticket.title)}</div>
              <div class="ticket-meta">${dateStr}${submitter}</div>
            </div>
            <div class="ticket-header-right">
              ${quickActionHtml}
              <span class="priority-badge ${ticket.priority}">${escapeHtml(ticket.priority)}</span>
              <span class="ticket-toggle">+</span>
            </div>
          </div>
          <div class="ticket-body">
            <div class="ticket-description">${escapeHtml(ticket.description)}</div>

            <div class="comments-section">
              <div class="comments-title">Comments (${(ticket.comments || []).length})</div>
              ${commentsHtml}
              ${commentFormHtml}
            </div>

            ${actionsHtml}
          </div>
        </div>
      `;
    }

    // Submit new ticket
    document.getElementById('ticketForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      const formStatus = document.getElementById('formStatus');

      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      formStatus.className = 'status-message';
      formStatus.style.display = 'none';

      const ticketData = {
        adminPassword: getAdminPassword(),
        title: document.getElementById('ticketTitle').value.trim(),
        description: document.getElementById('ticketDescription').value.trim(),
        priority: document.getElementById('ticketPriority').value,
        submittedBy: document.getElementById('ticketSubmitter').value.trim()
      };

      try {
        const response = await fetch('/api/tickets', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(ticketData)
        });

        const result = await response.json();

        if (response.ok && result.success) {
          formStatus.textContent = 'Request submitted successfully!';
          formStatus.className = 'status-message success';
          this.reset();

          // Collapse form and reload tickets
          document.getElementById('submitToggle').classList.remove('active');
          document.getElementById('submitForm').classList.remove('open');
          loadTickets();
        } else {
          throw new Error(result.error || 'Failed to submit request');
        }

      } catch (error) {
        formStatus.textContent = error.message || 'Failed to submit. Please try again.';
        formStatus.className = 'status-message error';
      }

      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Request';
    });

    // Update ticket status
    async function updateStatus(ticketId, newStatus) {
      try {
        const response = await fetch('/api/tickets', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            adminPassword: getAdminPassword(),
            ticketId: ticketId,
            status: newStatus
          })
        });

        const result = await response.json();
        if (result.success) {
          loadTickets();
        } else {
          alert(result.error || 'Failed to update status');
        }
      } catch (error) {
        alert('Error updating status: ' + error.message);
      }
    }

    // Add comment to ticket
    async function addComment(ticketId) {
      const input = document.getElementById('comment-' + ticketId);
      const text = input.value.trim();
      if (!text) return;

      try {
        const response = await fetch('/api/tickets', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            adminPassword: getAdminPassword(),
            ticketId: ticketId,
            addComment: {
              text: text,
              author: sessionStorage.getItem('boardUser') || 'Board Member'
            }
          })
        });

        const result = await response.json();
        if (result.success) {
          input.value = '';
          loadTickets();
        } else {
          alert(result.error || 'Failed to add comment');
        }
      } catch (error) {
        alert('Error adding comment: ' + error.message);
      }
    }

    // Delete modal
    function openDeleteModal(ticketId, ticketTitle) {
      document.getElementById('deleteTicketId').value = ticketId;
      document.getElementById('deleteTicketTitle').textContent = ticketTitle;
      document.getElementById('deleteModal').classList.add('active');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('active');
    }

    async function confirmDelete() {
      const ticketId = document.getElementById('deleteTicketId').value;

      try {
        const response = await fetch('/api/tickets', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            adminPassword: getAdminPassword(),
            ticketId: ticketId
          })
        });

        const result = await response.json();
        if (result.success) {
          closeDeleteModal();
          loadTickets();
        } else {
          alert(result.error || 'Failed to delete ticket');
        }
      } catch (error) {
        alert('Error deleting ticket: ' + error.message);
      }
    }

    // Close-with-comment modal
    function openCloseModal(ticketId, ticketTitle) {
      document.getElementById('closeTicketId').value = ticketId;
      document.getElementById('closeTicketTitle').textContent = ticketTitle;
      document.getElementById('closeComment').value = '';
      document.getElementById('closeModal').classList.add('active');
      document.getElementById('closeComment').focus();
    }

    function closeCloseModal() {
      document.getElementById('closeModal').classList.remove('active');
    }

    async function confirmClose() {
      const ticketId = document.getElementById('closeTicketId').value;
      const comment = document.getElementById('closeComment').value.trim();

      if (!comment) {
        document.getElementById('closeComment').focus();
        return;
      }

      try {
        // Add closing comment first
        await fetch('/api/tickets', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            adminPassword: getAdminPassword(),
            ticketId: ticketId,
            addComment: {
              text: comment,
              author: sessionStorage.getItem('boardUser') || 'Admin'
            }
          })
        });

        // Then mark as completed
        const response = await fetch('/api/tickets', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            adminPassword: getAdminPassword(),
            ticketId: ticketId,
            status: 'completed'
          })
        });

        const result = await response.json();
        if (result.success) {
          closeCloseModal();
          loadTickets();
        } else {
          alert(result.error || 'Failed to close ticket');
        }
      } catch (error) {
        alert('Error closing ticket: ' + error.message);
      }
    }

    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });

    // Load tickets on page load
    loadTickets();
  </script>

</body>
</html>
